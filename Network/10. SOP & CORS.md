## ğŸš¸ ëª©ì°¨
1. ğŸŒ³ ì¶œì²˜ë€?
2. ğŸŒ³ SOP
3. ğŸŒ³ CORS<br>


## ğŸŒ³ ì¶œì²˜(Origin)ë€?
<img width = "70%" src="./image/10. SOP&CORS/URL.png"></br>
- ë‘ URLì˜ í”„ë¡œí† ì½œ, í˜¸ìŠ¤íŠ¸, í¬íŠ¸(ëª…ì‹œë˜ì—ˆì„ ê²½ìš°)ê°€ ê°™ì„ê²½ìš° ì´ë¥¼ 'ë™ì¼í•œ ì¶œì²˜'ë¼ê³  ì´ì•¼ê¸°í•œë‹¤.
- ìœ„ ê·¸ë¦¼ì—ì„œ ë³´ì´ë“¯ì´ ì¸í„°ë„· ì°½ì— ê°œë°œìë„êµ¬ë¥¼ ì—´ê³  'location'ì„ ì…ë ¥í•˜ë©´ í•´ë‹¹ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
<table>
    <tr>
        <th>URL</th>
        <th>ê²°ê³¼</th>
        <th>ì´ìœ </th>
    </tr>
    <tr>
        <td>http://store.company.com/dir2/other.html</td>
        <td>ë™ì¼ ì¶œì²˜</td>
        <td>ê²½ë¡œë§Œ ë‹¤ë¦„</td>
    </tr>
    <tr>
        <td>http://store.company.com/dir/inner/another.html</td>
        <td>ë™ì¼ ì¶œì²˜</td>
        <td>ê²½ë¡œë§Œ ë‹¤ë¦„</td>
    </tr>
    <tr>
        <td>https://store.company.com/page.html</td>
        <td>ì‹¤íŒ¨</td>
        <td>ë‹¤ë¥¸ í”„ë¡œí† ì½œ</td>
    </tr>
    <tr>
        <td>http://store.company.com:81/dir/page.html</td>
        <td>ì‹¤íŒ¨</td>
        <td>ë‹¤ë¥¸ í¬íŠ¸ (http:// ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ 80 í¬íŠ¸)</td>
    </tr>
    <tr>
        <td>http://news.company.com/dir/page.html</td>
        <td>ì‹¤íŒ¨</td>
        <td>ë‹¤ë¥¸ í˜¸ìŠ¤íŠ¸</td>
    </tr>
</table>

- ìœ„ í‘œì™€ ê°™ì´ í”„ë¡œí† ì½œ, í˜¸ìŠ¤íŠ¸, í¬íŠ¸ê°€ ë‹¤ë¥¼ ê²½ìš° ë™ì¼í•˜ì§€ ì•Šì€ ì¶œì²˜(êµì°¨ì¶œì²˜)ë¼ê³  í•œë‹¤.
- ë§Œì¼ í´ë¼ì´ì–¸íŠ¸(3000í¬íŠ¸), ì„œë²„(8080í¬íŠ¸)ì—ì„œ ì‹¤í–‰ í›„ ìš”ì²­ì„ ë³´ë‚¸ë‹¤ë©´?
```
XMLHttpRequest cannot load 'http://localhost:3000'. No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin 'http://localhost:8080' is therefore not allowed access.
```

## ğŸŒ³ SOP(ë™ì¼ ì¶œì²˜ ì •ì±…, Same-Origin Policy)
- ì–´ë–¤ ì¶œì²˜ì—ì„œ ë¶ˆëŸ¬ì˜¨ ë¬¸ì„œë‚˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ë‹¤ë¥¸ ì¶œì²˜ì—ì„œ ê°€ì ¸ì˜¨ ë¦¬ì†ŒìŠ¤ì™€ ìƒí˜¸ ì‘ìš©í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì œí•œí•˜ëŠ” ì¤‘ìš”í•œ ë³´ì•ˆ ë©”ì»¤ë‹ˆì¦˜
- ì¦‰, ë³´ì•ˆì„ ìœ„í•´ ë™ì¼í•œ ì¶œì²˜ì˜ ì„œë²„ë¡œë§Œ ìš”ì²­ì„ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆë„ë¡ í•œ ì •ì±…ì´ë‹¤.

## ğŸŒ³ CORS(êµì°¨ ì¶œì²˜ ë¦¬ì†ŒìŠ¤ ê³µìœ , Cross-Origin-Resource Sharing)
- ë™ì¼ ì¶œì²˜ ë³´ì•ˆ ì •ì±…(SOP)ì€ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì¶œì²˜ ê°„ ì ‘ê·¼ì„ ê¸ˆì§€í•œë‹¤. ê·¸ëŸ¬ë‚˜ CORSëŠ” ì›¹ ì„œë²„ê°€ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì¶œì²˜ ê°„ ì ‘ê·¼ì„ í—ˆìš©í•˜ë„ë¡ ì„ íƒí•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.
- ì¦‰, ë„ë©”ì¸ì´ ë‹¤ë¥¸ ì„œë²„ë¼ë¦¬ ë¦¬ì†ŒìŠ¤ë¥¼ ì£¼ê³  ë°›ì„ ë•Œ ë³´ì•ˆì„ ìœ„í•´ ì„¤ì •ëœ ì •ì±…

### ğŸŒ¿ Simple Request
- ì•„ë˜ì˜ ìš”ì²­ì— ëŒ€í•´ì„  cors ê²€ì‚¬ë¥¼ í•˜ì§€ ì•ŠëŠ”ë‹¤.
```
- ë‹¤ìŒ ì¤‘ í•˜ë‚˜ì˜ ë©”ì„œë“œ
    - GET, POST, HEAD
- Request Headerì—ëŠ” ë‹¤ìŒ ì†ì„±ë§Œ í—ˆìš©
    - Accept
    - Accept-Lauguage
    - Content-Lauguage
    - Content-Type
        - application/x-www-form-urlencoded
        - multipart/form-data
        - text/plain
...
```
- ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ê²ƒì€ Content-Typeì´ë‹¤.
- ëŒ€ë¶€ë¶„ì˜ HTTP APIì—ì„œ ìš°ë¦¬ê°€ ì „ì†¡í•˜ëŠ” Content-Typeì€ ì•„ë˜ì™€ ê°™ê¸° ë•Œë¬¸ì´ë‹¤. 
    - text/xml
    - application/json
- ì´ë•Œë¬¸ì— ìš°ë¦¬ëŠ” ë‹¤ë¥¸ ì†ì„±ë„ í—ˆê°€í•  ìˆ˜ ìˆë„ë¡ ìš”ì²­ì„ ë³´ë‚´ì•¼ í•˜ê³  ê·¸ ë°©ì‹ì´ PreFilght ì´ë‹¤.

<img width = "70%" src="./image/10. SOP&CORS/preflight.png"></br>

### ğŸŒ¿ PreFilght
- ì´ ì‹œë‚˜ë¦¬ì˜¤ì—ì„  Simple Requestë¥¼ ë³´ë‚´ê¸° ì „ ì˜ˆë¹„ìš”ì²­ì„ í•œë²ˆ ë” ë³´ë‚´ê²Œ ëœë‹¤.
- ì¦‰, simple Requestì™€ ì „ë°˜ì ì¸ ë¡œì§ì€ ê°™ê³  ì•ì— ì˜ˆë¹„ìš”ì²­ì˜ ìœ ë¬´ ì°¨ì´ì´ë‹¤.
- ì´ ìš”ì²­ì—ì„œëŠ” HTTP ë©”ì†Œë“œ ì¤‘ OPTIONS ë©”ì†Œë“œê°€ ì‚¬ìš©ëœë‹¤.
    - ë³¸ ìš”ì²­ì„ ë³´ë‚´ê¸° ì „ì— ë¸Œë¼ìš°ì € ìŠ¤ìŠ¤ë¡œ ì´ ìš”ì²­ì„ ë³´ë‚´ëŠ” ê²ƒì´ ì•ˆì „í•œì§€ í™•ì¸
    - OPTIONS ìš”ì²­ì„ ë°›ì€ ì„œë²„ëŠ” Response Headerì— ì„œë²„ê°€ í—ˆìš©í•  ì˜µì…˜ì„ ì„¤ì •í•˜ì—¬ ë¸Œë¼ìš°ì €ì—ê²Œ ì „ë‹¬
- ì˜ˆë¥¼ ë“¤ì–´ ë‹µ í—¤ë”ì— Access-Control-Allow-Origin í•­ëª©ì„ ì¶”ê°€í•˜ì—¬ í—ˆìš©í•  ë„ë©”ì¸ì„ ì§€ì •í•  ìˆ˜ ìˆëŠ”ë°, ì„¤ì •í•˜ê²Œ ë˜ë©´ ê°œë°œì ë„êµ¬ì—ì„œ ì•„ë˜ì™€ ê°™ì´ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
```
Access-Control-Allow-Origin: https://example.com

```

<img width = "70%" src="./image/10. SOP&CORS/preflight_correct.png"></br>

- ìœ„ëŠ” preflight ìš”ì²­ í›„ ë³¸ìš”ì²­ê¹Œì§€ ë‚ ë ¸ì„ë•Œì˜ ìƒí™©ì„ ê·¸ë¦¼ìœ¼ë¡œ í‘œí˜„í•˜ ê²ƒì´ë‹¤.
- preflight ìš”ì²­ í›„ ë¸Œë¼ìš°ì €ëŠ” ì•„ë˜ì˜ ì‘ë‹µì„ ëŒë ¤ì¤€ë‹¤.
```
Access-Control-Allow-Origin: http://foo.example //í—ˆê°€ëœ Origin
Access-Control-Allow-Methods: POST, GET, OPTIONS //í—ˆê°€ëœ ë©”ì†Œë“œ
Access-Control-Allow-Headers: X-PINGOTHER, Content-Type //í—ˆê°€ëœ í—¤ë”
Access-Control-Max-Age: 86400 // ì‘ë‹µ ìºì‹œì˜ ìœ íš¨ì‹œê°„
```
- ìœ„ ì‘ë‹µì„ í•´ì„í•˜ë©´
- "í•´ë‹¹ APIê°€ Cross-Originì— ëŒ€í•´ì„œ POST, GET, OPTIONSì™€ ì»¤ìŠ¤í…€ í—¤ë”ì¸ X-PINGOTHER ê·¸ë¦¬ê³  Content-Typeì„ í—ˆìš©í•œë‹¤"
- ì¦‰, í•´ë‹¹ë˜ëŠ” ê²ƒë“¤ì€ ì•ˆì „í•˜ë‹¤ê³  íŒë‹¨í•˜ì—¬ CORS ìœ„ë°˜ìœ¼ë¡œ ê°„ì£¼í•˜ì§€ ì•Šê³ , ë¸Œë¼ìš°ì €ëŠ” POSTì¸ ë³¸ ìš”ì²­ì„ ë¸Œë¼ìš°ì €ëŠ” ì™¸ë¶€ ì„œë²„ë¡œ ë³´ë‚¸ë‹¤.

### ğŸŒ¿ CORS ì—ëŸ¬ í•´ê²°ë°©ë²•
#### Access-Control-Allow-Origin ì„¸íŒ…(JAVA)

#### 1. ì„œë²„ ì‘ë‹µ ë³´ë‚´ê¸° ì „ í—¤ë”ë¥¼ ì‹£ëŠ” í•„í„° ì‘ì„±
```java
@Component
@Order(Ordered.HIGHEST_PRECEDENCE)
public class CorsFilter implements Filter {

    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
    }

    @Override
    public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) throws IOException, ServletException {
        HttpServletRequest request = (HttpServletRequest) req;
        HttpServletResponse response = (HttpServletResponse) res;

        response.setHeader("Access-Control-Allow-Origin", "http://localhost:5500");
        response.setHeader("Access-Control-Allow-Credentials", "true");
        response.setHeader("Access-Control-Allow-Methods","*");
        response.setHeader("Access-Control-Max-Age", "3600");
        response.setHeader("Access-Control-Allow-Headers",
                "Origin, X-Requested-With, Content-Type, Accept, Authorization");

        if("OPTIONS".equalsIgnoreCase(request.getMethod())) {
            response.setStatus(HttpServletResponse.SC_OK);
        }else {
            chain.doFilter(req, res);
        }
    }

    @Override
    public void destroy() {

    }
}
```
- ëª¨ë“  ì„¤ì •ì„ ì¼ì¼íˆ ì‘ì„±í•´ ì£¼ê¸°ì—ëŠ” ì¢‹ì§€ë§Œ ë³µì¡í•˜ê³  ê¸¸ë‹¤.

#### 2. Annotation(@CrossOrigin)
- Controller ìƒë‹¨, ë‚´ë¬´ ë§¤í•‘ ë©”ì†Œë“œ ìƒë‹¨ì— ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì‘ì„±í•´ì¤€ë‹¤.
```java
@CrossOrigin(origins = "http://127.0.0.1:5500/")  // ì»¨íŠ¸ë¡¤ëŸ¬ í´ë˜ìŠ¤ì˜ ìƒë‹¨
@RequiredArgsConstructor
@RestController
public class ArticleRestController {

    public final ArticleRepository articleRepository;
    public final ArticleService articleService;
    public final LocationDistance location;

    @CrossOrigin(origins = "http://127.0.0.1:5500/")  // ì»¨íŠ¸ë¡¤ëŸ¬ ë§µí•‘ ë©”ì†Œë“œ ìƒë‹¨
    @GetMapping("/api/articles/{query}")
    public ResponseEntity<List<Article>> getArticles (@PathVariable("query") String query) {
        List<Article> articles = articleRepository.findAllByTitleContains(query);
        return ResponseEntity.ok().body(articles);
    }
}
```

#### 3. WebConfig í´ë˜ìŠ¤ ì‚¬ìš©í•˜ê¸°
- ê°€ì¥ ê°„ê²°í•˜ê²Œ corsì˜ˆì™¸ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.
```java
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**").allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
				.allowedOrigins("http://localhost:1234")
				.allowCredentials(true)
				.exposedHeaders("*")
				.maxAge(3600); // Preflight
    }
}
```
- ê·¸ ì™¸ì—ë„ ë” ë§ì€ ë©”ì†Œë“œê°€ ì¡´ì¬í•˜ë¯€ë¡œ í•„ìš”í•œê²Œ ìˆë‹¤ë©´ ì‘ì„±í•˜ë©´ ëœë‹¤.
```
.allowedOrigins()
.allowedMethods()
.allowCredentials()
.allowedHeaders()
.exposedHeaders()
.allowedOriginPatterns()
```
----

### ì¶œì²˜
- [ë™ì¼ ì¶œì²˜ ì •ì±…](https://developer.mozilla.org/ko/docs/Web/HTTP/CORS)
- [SOP&CORS](https://velog.io/@effirin/CORS%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%B8%EA%B0%80)
- [CORSì—ëŸ¬ í•´ê²°ë°©ë²•1](https://cat-minzzi.tistory.com/77)
- [CORS, Preflight ì¸ì¦ ê´€ë ¨ ì˜¤ë¥˜ í•´ê²°](https://www.popit.kr/cors-preflight-%EC%9D%B8%EC%A6%9D-%EC%B2%98%EB%A6%AC-%EA%B4%80%EB%A0%A8-%EC%82%BD%EC%A7%88/)
